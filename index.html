<!DOCTYPE html>
<html lang="gu">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>fridge crate map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=noto+sans+gujarati:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --bg:#f8fafc; --card:#ffffff; --muted:#475569; --accent:#22c55e;
            --danger:#ef4444; --text:#1e293b; --line:#e2e8f0;
        }
        *{box-sizing:border-box}
        body{
            margin:0; font-family:"noto sans gujarati", system-ui, sans-serif;
            background:var(--bg); color:var(--text); -webkit-tap-highlight-color: transparent;
        }
        .wrap{max-width:980px; margin:0 auto; padding:8px;}
        .card{background:var(--card); border:1px solid var(--line); border-radius:16px; box-shadow:0 4px 15px rgba(0,0,0,.07);}
        .header{padding:12px; border-bottom:1px solid var(--line); display:flex; align-items:center; justify-content:space-between; gap:12px;}
        h1{font-size:18px; margin:0; font-weight:700;}
        .controls{display:flex; gap:8px; align-items: center;}
        .date{font-weight:700; font-size: 14px;}
        button{appearance:none; border:0; border-radius:10px; padding: 8px 12px; font-weight:700; cursor:pointer;}
        .save{background:var(--accent); color:#fff;}
        .reset{background:var(--danger); color:#fff;}
        .status{font-size:12px; color:var(--muted); min-height:18px;}
        .content{padding: 12px;}
        .fridge-section{margin-bottom: 20px;}
        
        .custom-layout-grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-auto-rows: min-content; gap: 6px; }
        .fridge-name-box { grid-area: 3 / 1 / 5 / 2; display: flex; align-items: center; justify-content: center; border: 1px solid var(--line); border-radius: 8px; background: var(--bg); font-weight: 700; font-size: 15px; color: var(--muted); text-align: center; }
        .crate-box{ border:1px solid var(--line); border-radius:8px; background:var(--card); padding: 4px; }
        .crate-box select{ width:100%; border:1px solid var(--line); border-radius:5px; padding: 5px 2px; font-family:inherit; font-size:12px; font-weight:500; background-color:var(--bg); margin-bottom: 3px; }
        .half-section{display:flex; align-items:center; justify-content:center; gap:4px;}
        .half-section label{font-size:11px; color:var(--muted); font-weight:500;}
        .half-section input[type="checkbox"]{width:15px; height:15px; margin: 0;}
        .vertical-fridge-title { font-size:16px; font-weight:700; margin:0 0 10px 0; padding-bottom:6px; border-bottom:2px solid var(--accent); }
        .vertical-grid-container { display: grid; grid-template-columns: 1fr; gap: 6px; max-width: 150px; }

        @media (min-width: 500px) {
            .custom-layout-grid { gap: 10px; }
            .crate-box { padding: 8px; }
            .crate-box select { font-size: 14px; padding: 8px 5px; }
            .half-section label { font-size: 13px; }
            .fridge-name-box { font-size: 16px; }
            .vertical-grid-container { max-width: 200px; }
        }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card">
            <div class="header">
                <div>
                    <h1>ફ્રિજ કેરેટ મેપ</h1>
                    <div class="status" id="status">લોડ થઈ રહ્યું છે...</div>
                </div>
                <div class="controls">
                    <div class="date" id="datelabel">--</div>
                    <button class="save" id="savebtn">save</button>
                    <button class="reset" id="resetbtn">reset</button>
                </div>
            </div>
            <div class="content" id="content"></div>
        </div>
    </div>

    <script type="module">
        // ====== 1) config – તમારા પ્રોજેક્ટ માટે અપડેટ કર્યું છે ======
        const firebase_config = {
            apikey: "aizasyavmndknvdqcixwn-fasq77b9ovdamam7k",
            authdomain: "amul-stock.firebaseapp.com",
            projectid: "amul-stock",
            storagebucket: "amul-stock.firebasestorage.app",
            messagingsenderid: "721564107787",
            appid: "1:721564107787:web:d2e305a47e0a8becae730e"
        };
        
        const products = [ "ખાલી", "તાજા 150", "ગોલ્ડ 500", "તાજા 500", "t સ્પે ગીર", "a તાજા 500", "t સ્પે અમુલ", "છાસ ગીર", "છાસ 680", "છાસ 300", "ff 150", "દહીં 850", "દહીં 1 kg", "દહીં 5 kg", "ગોલ્ડ 6 લી" ];
        const fridges = { white_fridge: { name: "વ્હાઇટ ફ્રિજ", count: 14, layout: 'custom' }, blue_fridge: { name: "બ્લુ ફ્રિજ", count: 14, layout: 'custom' }, amul_fridge: { name: "અમુલ ફ્રિજ", count: 14, layout: 'custom' }, fourth_fridge: { name: "ચોથું ફ્રિજ", count: 4, layout: 'vertical' } };

        // ====== 3) firebase (web v11+ modular via cdn) ======
        import { initializeapp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getauth, onauthstatechanged, signinanonymously } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getfirestore, doc, setdoc, updatedoc, getdoc, onsnapshot, enableindexeddbpersistence } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const app = initializeapp(firebase_config);
        const auth = getauth(app);
        const db = getfirestore(app);
        try { await enableindexeddbpersistence(db); } catch(e) { console.warn('persistence:', e.message); }

        // dom & setup
        const $status = document.getelementbyid('status');
        const $content = document.getelementbyid('content');
        const datekey = new date(new date().tolocalstring('en-us', { timezone: 'asia/kolkata' })).toisostring().slice(0, 10);
        document.getelementbyid('datelabel').textcontent = `તારીખ: ${datekey.split('-').reverse().join('-')}`;
        const docref = doc(db, 'fridge_crates', datekey);

        // ui builder
        function buildui() {
            $content.innerhtml = '';
            const productoptions = products.map(p => `<option value="${p}">${p}</option>`).join('');
            for (const [fridgeid, fridgedata] of object.entries(fridges)) {
                const section = document.createelement('div'); section.classname = 'fridge-section';
                if (fridgedata.layout === 'custom') {
                    const grid = document.createelement('div'); grid.classname = 'custom-layout-grid';
                    let crateindex = 0;
                    for(let row=1; row<=4; row++){
                        for(let col=1; col<=4; col++){
                            if((row === 3 || row === 4) && col === 1) continue;
                            if(crateindex >= fridgedata.count) break;
                            const cratebox = createcratebox(fridgeid, crateindex, productoptions);
                            cratebox.style.gridarea = `${row} / ${col} / span 1 / span 1`;
                            grid.appendchild(cratebox); crateindex++;
                        }
                    }
                    const namebox = document.createelement('div'); namebox.classname = 'fridge-name-box';
                    namebox.textcontent = fridgedata.name; grid.appendchild(namebox);
                    section.appendchild(grid);
                } else {
                    const title = document.createelement('h2'); title.classname = 'vertical-fridge-title';
                    title.textcontent = fridgedata.name; section.appendchild(title);
                    const grid = document.createelement('div'); grid.classname = 'vertical-grid-container';
                    for (let i = 0; i < fridgedata.count; i++) { grid.appendchild(createcratebox(fridgeid, i, productoptions)); }
                    section.appendchild(grid);
                }
            }
        }
        function createcratebox(fridgeid, index, productoptions) {
            const cratebox = document.createelement('div'); cratebox.classname = 'crate-box';
            cratebox.innerhtml = `<select data-fridge="${fridgeid}" data-index="${index}" data-type="product">${productoptions}</select><div class="half-section"><input type="checkbox" id="half_${fridgeid}_${index}" data-fridge="${fridgeid}" data-index="${index}" data-type="ishalf"><label for="half_${fridgeid}_${index}">અળધુ</label></div>`;
            return cratebox;
        }
        
        // data handling & firebase
        let state = {};
        const getinitialstate = () => { const i = {}; for (const f in fridges) { i[f] = array(fridges[f].count).fill({ product: 'ખાલી', ishalf: false }); } return i; };
        let applyingremote = false;

        // નવું ફંક્શન: UI માંથી વર્તમાન સ્ટેટ વાંચે છે
        function readstatefromui() {
            const currentstate = {};
            for (const [fridgeid, fridgedata] of object.entries(fridges)) {
                currentstate[fridgeid] = [];
                for (let i = 0; i < fridgedata.count; i++) {
                    const productselect = document.queryselector(`select[data-fridge="${fridgeid}"][data-index="${i}"]`);
                    const ishalfcheck = document.queryselector(`input[data-fridge="${fridgeid}"][data-index="${i}"]`);
                    currentstate[fridgeid].push({
                        product: productselect ? productselect.value : 'ખાલી',
                        ishalf: ishalfcheck ? ishalfcheck.checked : false,
                    });
                }
            }
            return currentstate;
        }

        function applystatetoui(sourcestate) {
            applyingremote = true;
            for (const [fridgeid, data] of object.entries(sourcestate)) {
                if (!data) continue;
                data.foreach((crate, index) => {
                    const productselect = document.queryselector(`select[data-fridge="${fridgeid}"][data-index="${index}"]`);
                    const ishalfcheck = document.queryselector(`input[data-fridge="${fridgeid}"][data-index="${index}"]`);
                    if (productselect) productselect.value = crate.product || 'ખાલી';
                    if (ishalfcheck) ishalfcheck.checked = crate.ishalf || false;
                });
            }
            applyingremote = false;
        }
        
        function setstatus(msg){ $status.textcontent = msg; cleartimeout(setstatus._t); setstatus._t = settimeout(()=>{$status.textcontent=''}, 2500); }
        
        // saveState ફંક્શનમાં સુધારો
        async function savestate() {
            setstatus('સેવ થઈ રહ્યું છે...');
            try {
                // UI માંથી વર્તમાન સ્ટેટ વાંચો
                const currentstatetosave = readstatefromui();
                await setdoc(docref, { ...currentstatetosave, updatedat: new date() });
                setstatus('સેવ થઈ ગયું ✅');
            } catch (error) {
                console.error("save failed:", error);
                setstatus('સેવ નિષ્ફળ ❌');
            }
        }

        $content.addeventlistener('change', (e) => {
            if (applyingremote || !(e.target.matches('select') || e.target.matches('input[type="checkbox"]'))) return;
            
            const { fridge, index, type } = e.target.dataset;
            const value = (type === 'ishalf') ? e.target.checked : e.target.value;
            
            // અહીં, આપણે સીધા 'state' ઓબ્જેક્ટને અપડેટ કરીએ છીએ.
            // આ ભાગને બદલવાની જરૂર નથી, કારણ કે saveState હવે UI માંથી સીધો ડેટા વાંચશે
            // પરંતુ UI માં ઇન્સ્ટન્ટ ફીડબેક માટે આ જરૂરી છે
            if (state[fridge] && state[fridge][index]) {
              state[fridge][index][type] = value;
            }
            setstatus('ફેરફાર સેવ કરવા save દબાવો');
        });

        document.getelementbyid('savebtn').addeventlistener('click', savestate);

        document.getelementbyid('resetbtn').addeventlistener('click', async () => {
            if (!confirm('આજે માટે આખું લેઆઉટ સાફ કરવા reset કરશો?')) return;
            state = getinitialstate();
            setstatus('રીસેટ થઈ રહ્યું છે...');
            await setdoc(docref, { ...state, date: datekey, createdat: new date() });
            setstatus('રીસેટ થઈ ગયું ✅');
        });
        
        // નવી અને સુધારેલી onauthstatechanged() ફંક્શન
        onauthstatechanged(auth, async (user) => {
            if (!user) {
                try { await signinanonymously(auth); } catch(e) { console.error("sign-in failed", e); setstatus('ઓથેન્ટિકેશન નિષ્ફળ ❌'); }
                return;
            }
            
            buildui(); // UI બિલ્ડ થયા પછી ડેટા લોડ કરો
            setstatus('લોડ થઈ રહ્યું છે...');

            onsnapshot(docref, (docsnap) => {
                if (!docsnap.exists()) {
                    state = getinitialstate();
                    setdoc(docref, { ...state, date: datekey, createdat: new date() });
                    setstatus('નવો દિવસ ✅');
                    return;
                }
                
                state = { ...getinitialstate(), ...docsnap.data() };
                applystatetoui(state);
                setstatus('રીયલટાઇમ જોડાયેલ ✅');
            }, (error) => {
                console.error("snapshot error:", error);
                setstatus('રીયલટાઇમ કનેક્શન તૂટ્યું ❌');
            });
        });
    </script>
</body>
</html>
